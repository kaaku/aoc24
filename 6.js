const input = `\
.............#........................................................#...#...........................................#...........
.....#...............................#.........................................#...#...............#........##...............#.#..
..................................#..................#.......................................#...#................................
.........................................#................#....#..............................................#................#.#
........#.........................................................#...........#.......#..............................#............
........................#.............................#.......................#.......#.......................#........#.........#
................................#.......#............................................#...........................................#
...........#........#...#..#...........................#..................#.............#.......#..........................#......
............................................#........#.......#..#......#..............................#..#................##......
............#..#...#......#.........................................##.......#..........#.......#...................#.............
.....................................................................................#.....#......................................
.......................................................#................#.....................................#...................
...........#.....#.#....................................#.......#.#...........#................#.......#.................#........
............#.............#....................#....#............................#.........................................#......
.#..........#......#................#........................#............#..#..............#.....................................
..................#....#...........................................#.....#.....#.........................................#.#......
.............#..............#..#...........................#..#..........#...............................#........................
.................................................................................................#................................
.......................................................#..............#..............................................#..#.........
......#............................#.......................#................................................................#.....
..........#.........#..................#....#....#...#......#.........#.................................#........................#
..#...#............................#............#.......###.................................#.............................#...#...
.................#....#...................#........................................................................#..........#...
....#..........................#......................................................................#.....#......#..............
.#........................................................................#..........#............#..................#............
...................##.#.......................#....#.#........................................#.........##........................
#...........................................................#..........#........#.#..................................#............
.......#...#.........................................#.......#........#...............##..#.......................................
......................#....#...............................#......................................................#..#............
......#.....................................................#...............................#......................#..#...........
.........................#.#......................................................................................................
.......................................#...............#...................#................#..........#.#......................#.
.......#......#...#...........................#.........................#...............#..#...............#.............##.......
.....#..#..#..................#............#......................................................#...#.........................#.
#.#...............#...........#................#...................................................#..........#...................
..........................................................................#...............................................#.......
.........#.......#..........................#.##.............................#..##...#.......................................#....
....#...............#..........#........................................#.....#.........................................#.........
...........#................................................#....##...................................................#..#........
........................#........#...........#...#............................................#......................##...........
......#........................................#...#.............................................#................................
#.....#......#..................................#.............#..#...............................#................................
..................#......................#..........#...................#............................................#....#.......
.................#.............................................................................#.......#..........................
......#........................................................................................#...#....................#.........
....#......................#..................##..................#.......#.......................#...........#.........#..#......
............................................................#......##.............................#.#.....#............#..........
..............#.......................#...^.....................................#.....................................#...........
..............#...##......#..#.....#..........................................................................#.......#.........#.
.#................................................................#........##......#....#.......#.................................
....#.....................#........#...........#.............................................#........#................#......#..#
...................#.............#.........#.........................#...........#..................#...................#....#....
.#...............................................#.....#..#...#...................................................................
........................##............#.....................................#........#..................................#.........
..............#................................#.....................................#...................................#........
...........#..........#...........#........#...................#..#..........................#....................................
.#..............................................................#....#.......#.....................................#..............
.....................#........#......#................#.............#........................#.......................#........#...
.........................#..............#...#....#..................#.............................................................
..#............................##.........................................................#...........................#.#..#......
.....#............#...##........#..........#....#......#................................#.................#...............#....#..
.....#...............#.............................#............#......#....#........................................#............
...#..........#.........#.....................##.......#.....#...................#................................................
.................................#...........................................#.................#...........................#......
..........................................................#........................#.......#.................................#...#
..#......#......................................#...#..#....................#...........#....#.............................#......
..#........#.............#......................#...#.....#....#........................#..#......................................
.........#...........#.......................................................................#.........#....#...#.................
..................................#....#.............##....#.......#.........#.........................................#..........
....#.................................................#.......#...........#.......................................##.....#........
..............................#.........................................................#.....#........................#..........
...#........#...........#..#..................................................#..............#.............................#......
................................................#...............................................................#.....#..#.....#..
...............#.........................#..#...................#....................................#................#...........
............................#...........................................................................................#.........
.....#.........................#.......#..#..##.............................#................##.......##............#.............
.........#........................................................................................................................
.........................#............................#........................#.....#..........#.....................#...#..#....
.......#........#..............................#..........................#...#.................#............#....................
#...#..#...............................#..........................................#...#...#.........................#.............
...........................................................#..............#..........#..................#.........................
...........................................................#..............................................................#....#..
...........#.......................#................#......#.....................................#..................#.....#.......
.....#.................................#........................#.#...................#.....#............#........................
...........................#.#............#..............#..............#..#...#..........................#................#......
.........#...................#........................#......#..#..................................................#..............
.............................................#.................................................................#.......#.......#..
#.......................#...............#.......................#...........#................................#....................
......................................#............#....................................................##...................#....
#...............#...........................................#......#....................................#...............#.........
...#...............#.................................#..................................#..#............#.........................
......................#..#............#..#..............................................#......#....#...............#.............
..................#.....................#.....#...................#..#................#....#..........#......#..........#.........
.......................#.....#..............#..........................#............#...................#.#.......................
......#...........#..............#........#........................................#......................................#.......
............#................#..##....................................................................#........................#..
...........#....................................#.............................#.....#....#...#.#......................#...........
...................................................#...............................#....................#.........#...............
........#......#..#................#..................................................................#.................#.........
.............................#................................................#...........#.....#....#............................
........#.............#.........#............#....#.....................#........#...............#................................
..#................................#................................#..#......#.............................................#.....
.........#...........................................#..................................#....#..#.....................#...........
.....................................................#.........................................................#..................
.........#...#.#.....#.......##................................#...#..........................#........#..........................
......................##...............................#..........................................................................
.........#...#.....#........................................#................#........#............#........#.....................
...............#............#.................................................................#................................#..
......#..............#...................................................#............#.....................#.....................
.........#.........#..............................................................................................................
.#........#...............#..##......#..............................#...........#..#.........#...........................#........
...................#................................................................................#...............#.............
..............................................................................#........................#................#.........
...........#.....#..#.#....................................................#......#......#..#................##...................
....#......#...................................................................#..............#.....#.........#..................#
..#...........#...#...........#.......##..........##......................#......................................................#
..................#................................................#.#............................................................
#................................................................#............#...##..........................................#...
......#............................................#.......#.#.................................................#..................
..............................#..............#.#....#............#..........................#.....................................
............................#..................................#.................#..#...........................................#.
.........................................#................#..................#...#............................#..#......#........#
....................#..............................................................#..............................#..........##...
...#......................................#...........#..#............................................#.....#....#................
................#..#....#.........................................................................................................
...................................#...................#...............................#................................#.......#.
..........#.................#.............#..................#...............................................................#....
.....#...........#........#................#.........................................#..........................#......##.........
..........................#................#..............................................................#.......................
........#.................................................................#......................#.#..........................#...\
`;

const ORIGINAL_MAP = input.split('\n').map(row => row.split(''));
const WIDTH = ORIGINAL_MAP[0].length;
const HEIGHT = ORIGINAL_MAP.length;
const DIRECTIONS = ['UP', 'RIGHT', 'DOWN', 'LEFT'];
const INITIAL_POSITION = ORIGINAL_MAP
    .reduce((pos, row, index) => pos ?? (row.includes('^') ? { row: index, col: row.indexOf('^') } : null), null);
const INITIAL_DIRECTION = 'UP';

function getNextPosition(position, direction) {
    switch (direction) {
        case 'UP': return { row: position.row - 1, col: position.col };
        case 'RIGHT': return { row: position.row, col: position.col + 1 };
        case 'DOWN': return { row: position.row + 1, col: position.col };
        case 'LEFT': return { row: position.row, col: position.col - 1 };
    }
}

function turnRight(direction) {
    return DIRECTIONS[(DIRECTIONS.indexOf(direction) + 1) % direction.length];
}

function positionToKey(position) {
    return `${position.row}|${position.col}`;
}
 
function isInsideMap(position) {
    const { row, col } = position;
    return row >= 0 && col >= 0 && row < HEIGHT && col < WIDTH;
}

function isObstructed(map, position) {
    return map[position.row][position.col] === '#';
}

function isLooping(visited, nextPosition, direction) {
    return visited[positionToKey(nextPosition)]?.has(direction) ?? false;
}

function visit(visited, position, direction) {
    const key = positionToKey(position);
    if (!visited[key]) {
        visited[key] = new Set([direction]);
    } else {
        visited[key].add(direction);
    }
}

function solve(map, initialPosition, initialDirection) {
    const visitedLocations = {};
    let position = { ...initialPosition };
    let direction = initialDirection;
    visit(visitedLocations, position, direction);

    let nextPosition = getNextPosition(position, direction);
    while(isInsideMap(nextPosition)) {
        if (isObstructed(map, nextPosition)) {
            direction = turnRight(direction);
            nextPosition = getNextPosition(position, direction);
        } else if (isLooping(visitedLocations, nextPosition, direction)) {
            return { visitedLocations, result: 'LOOP' };
        } else {
            position = { ...nextPosition };
            visit(visitedLocations, position, direction);
            nextPosition = getNextPosition(position, direction);
        }
    }

    return { visitedLocations, result: 'EXIT' };
}

/* PART 1 */

const partOneSolution = solve(ORIGINAL_MAP, INITIAL_POSITION, INITIAL_DIRECTION);
console.log('Unique visited locations:', Object.keys(partOneSolution.visitedLocations).length);

/* PART 2 */

let possibleObstructions = Object.keys(partOneSolution.visitedLocations)
    .map(key => key.split('|'))
    .map(([row, col]) => ({ row, col }))
    .filter(position => position.row !== INITIAL_POSITION.row && position.col !== INITIAL_POSITION.col)
    .map(position => {
        const alteredMap = [...ORIGINAL_MAP.map(row => [...row])];
        alteredMap[position.row][position.col] = '#';
        return alteredMap;
    })
    .map(map => solve(map, INITIAL_POSITION, INITIAL_DIRECTION))
    .filter(solution => solution.result === 'LOOP')
    .length;

console.log('Possible obstruction locations:', possibleObstructions);
